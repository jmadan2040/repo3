This is 300 lines code
